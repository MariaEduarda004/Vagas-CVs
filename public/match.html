<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Matching de CVs | Vagas & CVs</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg bg-white border-bottom mb-3">
  <div class="container">
    <a class="navbar-brand fw-semibold" href="/index.html">Vagas & CVs</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div id="nav" class="collapse navbar-collapse">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="/jobs.html">Vagas</a></li>
        <li class="nav-item"><a class="nav-link" href="/cvs.html">CVs</a></li>
        <li class="nav-item"><a class="nav-link active" href="/match.html">Matching</a></li>
      </ul>
    </div>
  </div>
</nav>
<main class="container">
  <h1 class="h3 mb-3">Matching de CVs por Skills e Filtros</h1>
  <form id="matchForm" class="row g-3 bg-white border rounded p-3">
    <div class="col-12">
      <label class="form-label">Skills (separe por vírgulas)</label>
      <input class="form-control" name="skills" placeholder="ex.: node.js,javascript,docker">
      <div class="form-text">Dica: usamos interseção via <code>terms_set</code>. Defina quantas skills mínimas devem casar.</div>
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">Mínimo de Skills</label>
      <input class="form-control" name="min_skills" type="number" value="1" min="1">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">Senioridade</label>
      <input class="form-control" name="seniority" placeholder="jr/pl/sr">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">Tipo (CLT/PJ)</label>
      <input class="form-control" name="desired_type" placeholder="clt/pj">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">UF</label>
      <input class="form-control" name="uf" placeholder="RS/SP/...">
    </div>
    <div class="col-6 col-md-6">
      <label class="form-label">Cidade</label>
      <input class="form-control" name="city" placeholder="ex.: Porto Alegre">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">Texto Livre (opcional)</label>
      <input class="form-control" name="q" placeholder="ex.: elasticsearch mensageria">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">Qtd. Resultados</label>
      <input class="form-control" name="size" type="number" value="20" min="1" max="100">
    </div>
    <div class="col-12 d-flex gap-2">
      <button class="btn btn-primary">Rodar Matching</button>
      <button class="btn btn-outline-secondary" type="button" onclick="resetForm()">Limpar</button>
    </div>
  </form>
  <div id="results" class="mt-3"></div>
  <div class="modal fade" id="cvModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detalhes do CV</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <dl class="row mb-0">
          <dt class="col-sm-3">Nome</dt>
          <dd class="col-sm-9" id="cvName">—</dd>
          <dt class="col-sm-3">Headline</dt>
          <dd class="col-sm-9" id="cvHeadline">—</dd>
          <dt class="col-sm-3">Resumo</dt>
          <dd class="col-sm-9" id="cvSummary">—</dd>
          <dt class="col-sm-3">Local</dt>
          <dd class="col-sm-9" id="cvLocation">—</dd>
          <dt class="col-sm-3">Experiência</dt>
          <dd class="col-sm-9" id="cvYears">—</dd>
          <dt class="col-sm-3">Senioridade</dt>
          <dd class="col-sm-9" id="cvSeniority">—</dd>
          <dt class="col-sm-3">Tipo desejado</dt>
          <dd class="col-sm-9" id="cvDesiredType">—</dd>
          <dt class="col-sm-3">Skills</dt>
          <dd class="col-sm-9" id="cvSkills">—</dd>
          <dt class="col-sm-3">ID</dt>
          <dd class="col-sm-9"><code id="cvId">—</code></dd>
        </dl>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>
</main>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="/assets/app.js"></script>
<script>
  const form = document.getElementById('matchForm');
  const results = document.getElementById('results');
  const cvModal = new bootstrap.Modal(document.getElementById('cvModal'));

  function resetForm() { 
    form.reset(); 
    results.innerHTML = ''; 
  }

  function renderCvListWithView(hits = []) {
    if (!hits.length) return `<div class="alert alert-warning mb-0">Nenhum resultado</div>`;

    const items = hits.map(h => `
      <li class="list-group-item d-flex justify-content-between align-items-start">
        <div class="me-3">
          <div class="fw-semibold">${escapeHtml(h.name || '(sem nome)')}</div>
          <div class="text-muted small">${escapeHtml(h.headline || '')}</div>
          <div class="small">ID: <code>${escapeHtml(h.id)}</code> — Score: ${h.score?.toFixed?.(2) ?? h.score}</div>
          ${h.skills?.length ? `<div class="small">Skills: <em>${h.skills.map(escapeHtml).join(', ')}</em></div>` : ''}
          ${(h.location?.city || h.location?.uf) ? `<div class="small text-muted">${escapeHtml(h.location?.city || '')}${h.location?.uf ? ' / ' + escapeHtml(h.location.uf) : ''}</div>` : ''}
        </div>
        <div class="ms-3">
          <button class="btn btn-sm btn-outline-primary" onclick="viewCv('${h.id}')">Visualizar</button>
        </div>
      </li>
    `).join('');
    return `
      <div class="mb-2"><span class="badge text-bg-secondary">CVs: ${hits.length}</span></div>
      <ul class="list-group">${items}</ul>
    `;
  }
  
  async function viewCv(id) {
    try {
      const r = await fetch(`/cvs/${encodeURIComponent(id)}`);
      const cv = await r.json();

      if (!r.ok) {
        results.insertAdjacentHTML('afterbegin', `<div class="alert alert-danger">Falha ao carregar CV (${escapeHtml(id)})</div>`);
        return;
      }

      document.getElementById('cvId').textContent = cv.id || '—';
      document.getElementById('cvName').textContent = cv.name || '—';
      document.getElementById('cvHeadline').textContent = cv.headline || '—';
      document.getElementById('cvSummary').textContent = cv.summary || '—';
      const loc = (cv.location?.city || '') + (cv.location?.uf ? ' / ' + cv.location.uf : '');
      document.getElementById('cvLocation').textContent = loc || '—';
      document.getElementById('cvYears').textContent = (cv.years_exp ?? '—');
      document.getElementById('cvSeniority').textContent = cv.seniority || '—';
      document.getElementById('cvDesiredType').textContent = cv.desired_type || '—';
      document.getElementById('cvSkills').textContent = (cv.skills || []).join(', ') || '—';
      cvModal.show();

    } catch (e) {
      results.insertAdjacentHTML('afterbegin', `<div class="alert alert-danger">Erro inesperado ao abrir o CV.</div>`);
    }
  }
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(form);

    const skills = (fd.get('skills')||'')
      .split(',')
      .map(s => s.trim().toLowerCase())
      .filter(Boolean)
      .join(',');

    const params = new URLSearchParams();
    if (skills) params.set('skills', skills);
    
    ['min_skills','uf','city','seniority','desired_type','q','size'].forEach(k => {
      const v = (fd.get(k)||'').toString().trim();
      if (v) params.set(k, v);
    });

    const r = await fetch('/match/cvs?' + params.toString());
    const j = await r.json();
    if (!r.ok) {
      results.innerHTML = `<div class="alert alert-danger">Erro: ${escapeHtml(j.error||'falha')}</div>`;
      return;
    }
    results.innerHTML = renderCvListWithView(j.hits);
  });

  window.viewCv = viewCv;
</script>

</body>
</html>
